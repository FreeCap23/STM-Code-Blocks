# 14.Writing a task scheduler

## Description

A **task scheduler** manages when each piece of work (*task*) runs, so your code doesn’t need to wait using `HAL_Delay()`.  
It checks if it’s time for a task to run (using `HAL_GetTick()`), and runs it if enabled.

Example:

* Task 1 runs every 200 ms
* Task 2 runs every 50 ms
* Task 3 runs every 10 ms
* Task 4 runs every 113 ms
* ...up to Task 10

---

## Installation

1. **Create two files** in your project:
   * `Core/Inc/task_scheduler.h`
   * `Core/Src/task_scheduler.c`

2. **Copy the code** below into the files.

**task_scheduler.h**
```c
#ifndef __TASK_SCHEDULER_H
#define __TASK_SCHEDULER_H

/**
 * @brief Runs background tasks at their own speeds.
 * 
 * Goes through tasks one-by-one.  
 * If a task is enabled **and** it’s time for it to run, the scheduler will call it.  
 * Then it sets the time for the next run.
 */
void run_scheduled_tasks();

#endif
```

**task_scheduler.c**
```c
#include "task_scheduler.h"
#include <stdint.h>
#include <stdbool.h>
#include "stm32h7xx_hal.h"  // Change this if needed

// Example tasks
#define TASK1_PERIOD_MS 200
#define TASK1_ENABLED 1
static void task1() { /* ... */ }

#define TASK2_PERIOD_MS 50
#define TASK2_ENABLED 1
static void task2() { /* ... */ }

#define TASK3_PERIOD_MS 10
#define TASK3_ENABLED 1
static void task3() { /* ... */ }

#define TASK4_PERIOD_MS 113
#define TASK4_ENABLED 1
static void task4() { /* ... */ }

#define TASK5_PERIOD_MS 50
#define TASK5_ENABLED 1
static void task5() { /* ... */ }

#define TASK6_PERIOD_MS 50
#define TASK6_ENABLED 1
static void task6() { /* ... */ }

#define TASK7_PERIOD_MS 50
#define TASK7_ENABLED 1
static void task7() { /* ... */ }

#define TASK8_PERIOD_MS 50
#define TASK8_ENABLED 1
static void task8() { /* ... */ }

#define TASK9_PERIOD_MS 50
#define TASK9_ENABLED 1
static void task9() { /* ... */ }

#define TASK10_PERIOD_MS 50
#define TASK10_ENABLED 1
static void task10() { /* ... */ }

// Book-keeping
static uint32_t desired_periods[] = {
    TASK1_PERIOD_MS,
    TASK2_PERIOD_MS,
    TASK3_PERIOD_MS,
    TASK4_PERIOD_MS,
    TASK5_PERIOD_MS,
    TASK6_PERIOD_MS,
    TASK7_PERIOD_MS,
    TASK8_PERIOD_MS,
    TASK9_PERIOD_MS,
    TASK10_PERIOD_MS,
};
#define NUMBER_OF_TASKS (sizeof(desired_periods)/sizeof(desired_periods[0]))

// Enable/disable flags
static bool task_enabled[NUMBER_OF_TASKS] = {
    TASK1_ENABLED,
    TASK2_ENABLED,
    TASK3_ENABLED,
    TASK4_ENABLED,
    TASK5_ENABLED,
    TASK6_ENABLED,
    TASK7_ENABLED,
    TASK8_ENABLED,
    TASK9_ENABLED,
    TASK10_ENABLED,
};

// Next time to run each task. You don't need to change this manually
static uint32_t time_to_update[NUMBER_OF_TASKS] = {0};
static uint8_t sequencer = 0;

void run_scheduled_tasks() {
    // Array of functions to call for each task
    void (*tasks[])(void) = { task1, task2, task3, task4, task5, task6, task7, task8, task9, task10 };

    // Check if it’s time to run the current task and if it’s enabled
    if (HAL_GetTick() >= time_to_update[sequencer] && task_enabled[sequencer]) {
        // Run the task
        tasks[sequencer]();

        // Schedule its next run
        time_to_update[sequencer] = HAL_GetTick() + desired_periods[sequencer];
    }

    // Move to the next task (wrap to first if at the end)
    if (++sequencer >= NUMBER_OF_TASKS) {
        sequencer = 0;
    }
}
```

---

## Configuration

1. **Include the scheduler in `main.c`**:

```c
/* USER CODE BEGIN Includes */
#include "task_scheduler.h"
/* USER CODE END Includes */
```

2. **Call the scheduler in your main loop**:

```c
/* USER CODE BEGIN WHILE */
while (1) {
    run_scheduled_tasks();
    // Other non-blocking code here
}
```

**To change task periods or enable/disable tasks:**  
Edit the `#define TASKx_PERIOD_MS` and `#define TASKx_ENABLED` above each task function.

**To add a new task:**
1. Write a new `taskX()` static function.
2. Define its `TASKX_PERIOD_MS` and `TASKX_ENABLED` above the function.
3. Add `TASKX_PERIOD_MS` to `desired_periods[]`.
4. Add `TASKX_ENABLED` to `task_enabled[]`.
5. Add `taskX` to the `tasks[]` array in `run_scheduled_tasks()`.
6. `NUMBER_OF_TASKS` updates automatically.

---

## Usage

Write your task code inside `task1()`, `task2()`, etc. in `task_scheduler.c`.

Example:
```c
static void task1() {
    HAL_GPIO_TogglePin(GPIOA, GPIO_PIN_5); // Blink LED every 200 ms
}
```