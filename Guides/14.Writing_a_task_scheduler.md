# 14.Writing a task scheduler

## Description

A **task scheduler** is like a manager for your code.
It decides **when** each piece of work (called a *task*) should run, without stopping other work from happening.

Instead of writing code that just waits (using `HAL_Delay()`), the scheduler keeps checking if it’s time for a task to run, and runs it at the right moment.

Example:

* Task 1 runs every 200 milliseconds
* Task 2 runs every 50 milliseconds
* Task 3 runs every 10 milliseconds
* Task 4 runs every 113 milliseconds

The scheduler keeps track of time using `HAL_GetTick()` (a function from STM32 HAL that counts milliseconds since startup).

---

## Installation

1. **Create two files** in your project:

   * `Core/Inc/task_scheduler.h`
   * `Core/Src/task_scheduler.c`

2. **Copy the code** below into the files.

**task\_scheduler.h**

```c
#include <stdint.h>
#include <stdbool.h>

// How often each task should run (milliseconds)
uint32_t desired_periods[] = {200, 50, 10, 113};

// When each task should run next (milliseconds since start) (do not change these values, only add new ones if needed)
uint32_t time_to_update[] =  {0,   0,  0,  0};

// Whether each task is enabled (1 = run it, 0 = skip it)
bool task_enabled[] =        {1,   1,  1,  1};

// This variable tells which task to check next
extern uint8_t sequencer;

/**
 * @brief Runs background tasks at their own speeds.
 * 
 * Goes through tasks one-by-one.  
 * If a task is enabled **and** it’s time for it to run, the scheduler will call it.  
 * Then it sets the time for the next run.
 */
void run_scheduled_tasks();
```

**task\_scheduler.c**

```c
#include "task_scheduler.h"
#include "stm32h7xx_hal.h"  // Change this if needed

#define NUMBER_OF_TASKS 4  // Total number of tasks

uint8_t sequencer = 0; // Start with the first task

// Example tasks
static void task1() {
    // Put code for task 1 here
}

static void task2() {
    // Put code for task 2 here
}

static void task3() {
    // Put code for task 3 here
}

static void task4() {
    // Put code for task 4 here
}

void run_scheduled_tasks() {
    // Array of functions to call for each task
    void (*tasks[])(void) = { task1, task2, task3, task4 };

    // Check if it’s time to run the current task and if it’s enabled
    if (HAL_GetTick() >= time_to_update[sequencer] && task_enabled[sequencer]) {
        // Run the task
        tasks[sequencer]();

        // Schedule its next run
        time_to_update[sequencer] = HAL_GetTick() + desired_periods[sequencer];
    }

    // Move to the next task (wrap to first if at the end)
    if (++sequencer >= NUMBER_OF_TASKS) {
        sequencer = 0;
    }
}
```

---

## Configuration

You can change these things in `task_scheduler.h`:

* **`desired_periods[]`** → how often each task runs (in milliseconds)
  Example: `{200, 50, 10, 113}` means:

  * Task 1 every 200 ms
  * Task 2 every 50 ms
  * Task 3 every 10 ms
  * Task 4 every 113 ms

* **`task_enabled[]`** → turn tasks on or off
  Example: `{1, 0, 1, 1}` means Task 2 will not run at all.

* **`NUMBER_OF_TASKS`** → set to the total number of tasks you have.

* **Task functions** → change `task1()`, `task2()`, etc. to hold the code you want for each task.

* **Write new tasks** → write a new `taskx()` static function, add it to the tasks array in `run_scheduled_tasks()`, add a new value for it in `tasks_enabled[]` and `desired_periods[]` then update `NUMBER_OF_TASKS`.
  Example:
  ```c
  // task_scheduler.c
  static void task5() {
    // Code for task 5
  }
  ```
  `tasks[]` definition in `run_scheduled_tasks()` will become:
  ```c
  // Before
  void (*tasks[])(void) = { task1, task2, task3, task4 };
  // After
  void (*tasks[])(void) = { task1, task2, task3, task4, task5 };
  ```
  `tasks_enabled[]`, `desired_periods[]` `time_to_update` in `task_scheduler.h` will become:
  ```c
  // Before
  uint32_t desired_periods[] = {200, 50, 10, 113};
  uint32_t time_to_update[] =  {0,   0,  0,  0};
  bool task_enabled[] =        {1,   1,  1,  1};
  // After
  uint32_t desired_periods[] = {200, 50, 10, 113, 42};
  uint32_t time_to_update[] =  {0,   0,  0,  0,   0};
  bool task_enabled[] =        {1,   1,  1,  1,   1};
  ```
  `NUMBER_OF_TASKS` in `task_scheduler.c` will become:
  ```c
  // Before
  #define NUMBER_OF_TASKS 4
  // After
  #define NUMBER_OF_TASKS 5
  ```

---

## Usage

1. **Include the scheduler in `main.c`**:

```c
/* USER CODE BEGIN Includes */
#include "task_scheduler.h"
/* USER CODE END Includes */
```

2. **Call the scheduler in your main loop**:

```c
/* USER CODE BEGIN WHILE */
while (1) {
    run_scheduled_tasks();
    // Other non-blocking code here
}
```

3. **Write your task code** inside `task1()`, `task2()`, etc. in `task_scheduler.c`.

Example:

```c
static void task1() {
    HAL_GPIO_TogglePin(GPIOA, GPIO_PIN_5); // Blink LED every 200 ms
}
```