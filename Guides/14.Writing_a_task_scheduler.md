# 14.Writing a task scheduler

## Description

A **task scheduler** is like a manager for your code.
It decides **when** each piece of work (called a *task*) should run, without stopping other work from happening.

Instead of writing code that just waits (using `HAL_Delay()`), the scheduler keeps checking if it’s time for a task to run, and runs it at the right moment.

Example:

* Task 1 runs every 200 milliseconds
* Task 2 runs every 50 milliseconds
* Task 3 runs every 10 milliseconds
* Task 4 runs every 113 milliseconds

The scheduler keeps track of time using `HAL_GetTick()` (a function from STM32 HAL that counts milliseconds since startup).

---

## Installation

1. **Create two files** in your project:

   * `Core/Inc/task_scheduler.h`
   * `Core/Src/task_scheduler.c`

2. **Copy the code** below into the files.

**task\_scheduler.h**

```c
#ifndef __TASK_SCHEDULER_H
#define __TASK_SCHEDULER_H

/**
 * @brief Runs background tasks at their own speeds.
 * 
 * Goes through tasks one-by-one.  
 * If a task is enabled **and** it’s time for it to run, the scheduler will call it.  
 * Then it sets the time for the next run.
 */
void run_scheduled_tasks();

#endif
```

**task\_scheduler.c**

```c
#include "task_scheduler.h"
#include <stdint.h>
#include <stdbool.h>
#include "stm32h7xx_hal.h"  // Change this if needed

// Example tasks
#define TASK1_PERIOD_MS 200
static void task1() {
    // Put code for task 1 here
}

#define TASK2_PERIOD_MS 50
static void task2() {
    // Put code for task 2 here
}

#define TASK3_PERIOD_MS 10
static void task3() {
    // Put code for task 3 here
}

#define TASK4_PERIOD_MS 113
static void task4() {
    // Put code for task 4 here
}

/*
 * Scheduler Book-keeping
 */
// Total number of tasks
#define NUMBER_OF_TASKS (sizeof(desired_periods)/sizeof(desired_periods[0]))

static uint8_t sequencer = 0; // Start with the first task

// Periods defined before each task function
static uint32_t desired_periods[] = {
    TASK1_PERIOD_MS,
    TASK2_PERIOD_MS,
    TASK3_PERIOD_MS,
    TASK4_PERIOD_MS
};

// Enable/disable flags
static bool task_enabled[NUMBER_OF_TASKS] = {1, 1, 1, 1};

// Next time to run each task. You don't need to change this manually
static uint32_t time_to_update[NUMBER_OF_TASKS] = {0};

void run_scheduled_tasks() {
    // Array of functions to call for each task
    void (*tasks[])(void) = { task1, task2, task3, task4 };

    // Check if it’s time to run the current task and if it’s enabled
    if (HAL_GetTick() >= time_to_update[sequencer] && task_enabled[sequencer]) {
        // Run the task
        tasks[sequencer]();

        // Schedule its next run
        time_to_update[sequencer] = HAL_GetTick() + desired_periods[sequencer];
    }

    // Move to the next task (wrap to first if at the end)
    if (++sequencer >= NUMBER_OF_TASKS) {
        sequencer = 0;
    }
}
```

---

## Configuration

You can change these things in **`task_scheduler.c`**:

* **Task periods** → Each task has a `#define TASKx_PERIOD_MS` placed right above its function.
  Example:

  ```c
  #define TASK2_PERIOD_MS 50
  static void task2() {
      // Code for task 2
  }
  ```

* **`task_enabled[]`** → turn tasks on or off.
  Example (Task 2 disabled):

  ```c
  static bool task_enabled[NUMBER_OF_TASKS] = {1, 0, 1, 1};
  ```

* **Task functions** → change `task1()`, `task2()`, etc. to hold the code you want for each task.

* **Write new tasks** →

  1. Write a new `taskX()` static function.
  2. Define its `TASKX_PERIOD_MS` right above the function.
  3. Add the new task to the `desired_periods[]` initializer list.
  4. Add it to the `tasks[]` function pointer array in `run_scheduled_tasks()`.
  5. Add a value for it in `task_enabled[]` and `time_to_update[]`.
  6. `NUMBER_OF_TASKS` will automatically update, since it is computed from `desired_periods[]`.

  Example (adding Task 5):

  ```c
  #define TASK5_PERIOD_MS 42
  static void task5() {
      // Code for task 5
  }

  // Add to desired_periods
  static uint32_t desired_periods[] = {
      TASK1_PERIOD_MS,
      TASK2_PERIOD_MS,
      TASK3_PERIOD_MS,
      TASK4_PERIOD_MS,
      TASK5_PERIOD_MS
  };

  // Add to tasks[]
  void (*tasks[])(void) = { task1, task2, task3, task4, task5 };

  // Update arrays
  static bool task_enabled[NUMBER_OF_TASKS] = {1, 1, 1, 1, 1};
  static uint32_t time_to_update[NUMBER_OF_TASKS] = {0};
  ```

---

## Usage

1. **Include the scheduler in `main.c`**:

```c
/* USER CODE BEGIN Includes */
#include "task_scheduler.h"
/* USER CODE END Includes */
```

2. **Call the scheduler in your main loop**:

```c
/* USER CODE BEGIN WHILE */
while (1) {
    run_scheduled_tasks();
    // Other non-blocking code here
}
```

3. **Write your task code** inside `task1()`, `task2()`, etc. in `task_scheduler.c`.

Example:

```c
static void task1() {
    HAL_GPIO_TogglePin(GPIOA, GPIO_PIN_5); // Blink LED every 200 ms
}
```